<!DOCTYPE html>
<html>
<head>
    <title>Reporte Consolidado de Diferencias</title>
    <meta charset="UTF-8">
    <style>
        :root {
            --primary-color: #0366d6;
            --sidebar-width: 250px;
            --border-color: #e1e4e8;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            color: #24292e;
        }
        #sidebar {
            width: var(--sidebar-width);
            background-color: #f6f8fa;
            border-right: 1px solid var(--border-color);
            height: 100vh;
            overflow-y: auto;
            position: fixed;
        }
        #content {
            margin-left: var(--sidebar-width);
            padding: 20px;
            flex-grow: 1;
        }
        .server-item {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        .server-item:hover {
            background-color: #e1e4e8;
        }
        .server-item.active {
            background-color: var(--primary-color);
            color: white;
        }
        .diff-container {
            display: none;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }
        .diff-container.active {
            display: block;
        }
        .diff-header {
            background-color: #f6f8fa;
            padding: 8px 16px;
            border-bottom: 1px solid var(--border-color);
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
        }
        .diff-line {
            padding: 2px 16px;
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
            white-space: pre;
        }
        .diff-line-added {
            background-color: #e6ffed;
        }
        .diff-line-removed {
            background-color: #ffebe9;
        }
        .diff-line-info {
            background-color: #f1f8ff;
            color: #586069;
        }
        .file-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }
        .file-tab {
            padding: 5px 10px;
            margin-right: 5px;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .file-tab:hover {
            border-color: var(--border-color);
        }
        .file-tab.active {
            border-color: var(--border-color);
            border-bottom-color: white;
            margin-bottom: -1px;
        }
        .file-content {
            display: none;
        }
        .file-content.active {
            display: block;
        }
        h1 {
            margin-top: 0;
        }
        .timestamp {
            color: #586069;
            margin-bottom: 20px;
        }
        .no-changes {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            margin: 20px 0;
        }
        .error-message {
            background-color: #ffebee;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            margin: 20px 0;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h3 style="padding: 15px; margin: 0; border-bottom: 1px solid var(--border-color);">Servidores</h3>
        {% for host in play_hosts if host != "bastion.local.com" %}
            {% set fstab_diff_data = hostvars_diff.get(host, {}).get('fstab_diff_content', {}) %}
            {% set has_changes = fstab_diff_data.content is defined and fstab_diff_data.content | b64decode | length > 0 %}
            
            <div class="server-item" onclick="showServer('{{ host }}')">
                {{ host }}
                {% if has_changes %}
                    <span style="float: right; color: var(--primary-color);">●</span>
                {% else %}
                    <span style="float: right; color: #6a737d;">○</span>
                {% endif %}
            </div>
        {% endfor %}
    </div>

    <div id="content">
        <h1>Reporte Consolidado de Diferencias</h1>
        <div class="timestamp">Generado el: {{ ansible_date_time.date }} {{ ansible_date_time.time }}</div>
        <div class="timestamp">Generado por: {{ tower_user_name }} </div>
        <div class="timestamp">Titulo del Cambio: {{ titulo_cambio }} </div>
        
        {% for host in play_hosts if host != "bastion.local.com" %}
            {% set fstab_diff_data = hostvars_diff.get(host, {}).get('fstab_diff_content', {}) %}
            {% set has_changes = fstab_diff_data.content is defined and fstab_diff_data.content | b64decode | length > 0 %}

            {% set df_diff_data = hostvars_df_diff.get(host, {}).get('df_diff_content', {}) %}
            {% set has_df_changes = df_diff_data.content is defined and df_diff_data.content | b64decode | length > 0 %}

            {% set osversion_diff_data = hostvars_osversion_diff.get(host, {}).get('osversion_diff_content', {}) %}
            {% set has_osversion_changes = osversion_diff_data.content is defined and osversion_diff_data.content | b64decode | length > 0 %}

            {% set lsblk_diff_data = hostvars_lsblk_diff.get(host, {}).get('lsblk_diff_content', {}) %}
            {% set has_lsblk_changes = lsblk_diff_data.content is defined and lsblk_diff_data.content | b64decode | length > 0 %}
    
            <div id="{{ host }}" class="diff-container">
                
                <h2>{{ host }}</h2>
                
                <div style="border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; background-color: #f6f8fa; font-size: 14px; text-align: left;">
                     <table style="border-collapse: collapse; width: 100%;">
                       <tr>
                            <td style="font-weight: bold; padding: 4px;">OS:</td>
                            <td style="padding: 4px;">{{ hostvars[host].ansible_distribution }} {{ hostvars[host].ansible_distribution_version }}</td>
                            <td style="font-weight: bold; padding: 4px; width: 20%;">CPU:</td>
                            <td style="padding: 4px;">{{ hostvars[host].ansible_processor_vcpus }} vCPUs</td>
                        </tr>
                        <tr>
                            <td style="font-weight: bold; padding: 4px;">IP:</td>
                            <td style="padding: 4px;">{{ hostvars[host].ansible_host }}</td>
                            <td style="font-weight: bold; padding: 4px;">Memoria:</td>
                            <td style="padding: 4px;">{{ (hostvars[host].ansible_memtotal_mb / 1024) | round(1) }} GB</td>
                        </tr>
                        <tr>
                            <td style="font-weight: bold; padding: 4px;">Kernel:</td>
                            <td style="padding: 4px;">{{ hostvars[host].ansible_kernel }}</td>
                            <td style="font-weight: bold; padding: 4px;">Arquitectura:</td>
                            <td style="padding: 4px;">{{ hostvars[host].ansible_architecture }}</td>
                        </tr>
                     </table>
                </div>

        
                <div class="file-tabs">
                    <div class="file-tab active" onclick="showFile('{{ host }}', 'fstab')">FSTAB</div>
                    <div class="file-tab active" onclick="showFile('{{ host }}', 'df')">Salida DF</div>
                    <div class="file-tab active" onclick="showFile('{{ host }}', 'osversion')">OS Version</div>
                    <div class="file-tab active" onclick="showFile('{{ host }}', 'lsblk')">Salida LSBLK</div>
                    <div class="file-tab active" onclick="showFile('{{ host }}', 'vg')">Salida VG</div>                    
                    <div class="file-tab active" onclick="showFile('{{ host }}', 'netstat')">Rutas</div>      
                    <div class="file-tab active" onclick="showFile('{{ host }}', 'ipaddr')">Salida IPADDR</div>      
                </div>
        
            <div id="{{ host }}_fstab" class="file-content active">
                {% if not fstab_diff_data.content is defined %}
                    <div class="error-message">
                        No se encontraron datos de diferencias
                    </div>
                {% else %}
                    {% set fstab_diff_output = fstab_diff_data.content | b64decode %}
                    {% if fstab_diff_output | length > 0 %}
                        {% for line in fstab_diff_output.split('\n') %}
                            {% if line.startswith('+') and not line.startswith('+++') %}
                                <div class="diff-line diff-line-added">{{ line }}</div>
                            {% elif line.startswith('-') and not line.startswith('---') %}
                                <div class="diff-line diff-line-removed">{{ line }}</div>
                            {% elif line.startswith('@@') %}
                                <div class="diff-line diff-line-info">{{ line }}</div>
                            {% elif line.startswith('---') or line.startswith('+++') %}
                                <div class="diff-header">{{ line }}</div>
                            {% else %}
                                <div class="diff-line">{{ line }}</div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="no-changes">No se encontraron diferencias</div>
                    {% endif %}
                {% endif %}
            </div>

            <div id="{{ host }}_df" class="file-content">
                {% set df_diff_data = hostvars_df_diff.get(host, {}).get('df_diff_content', {}) %}
                {% if not df_diff_data.content is defined %}
                    <div class="error-message">
                        No se encontraron datos de diferencias
                    </div>
                {% else %}
                    {% set df_diff_output = df_diff_data.content | b64decode %}
                    {% if df_diff_output | length > 0 %}
                        {% for line in df_diff_output.split('\n') %}
                            {% if line.startswith('+') and not line.startswith('+++') %}
                                <div class="diff-line diff-line-added">{{ line }}</div>
                            {% elif line.startswith('-') and not line.startswith('---') %}
                                <div class="diff-line diff-line-removed">{{ line }}</div>
                            {% elif line.startswith('@@') %}
                                <div class="diff-line diff-line-info">{{ line }}</div>
                            {% elif line.startswith('---') or line.startswith('+++') %}
                                <div class="diff-header">{{ line }}</div>
                            {% else %}
                                <div class="diff-line">{{ line }}</div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="no-changes">No se encontraron diferencias</div>
                    {% endif %}
                {% endif %}
            </div>

            <div id="{{ host }}_osversion" class="file-content">
                {% set osversion_diff_data = hostvars_osversion_diff.get(host, {}).get('osversion_diff_content', {}) %}
                {% if not osversion_diff_data.content is defined %}
                    <div class="error-message">
                        No se encontraron datos de diferencias
                    </div>
                {% else %}
                    {% set osversion_diff_output = osversion_diff_data.content | b64decode %}
                    {% if osversion_diff_output | length > 0 %}
                        {% for line in osversion_diff_output.split('\n') %}
                            {% if line.startswith('+') and not line.startswith('+++') %}
                                <div class="diff-line diff-line-added">{{ line }}</div>
                            {% elif line.startswith('-') and not line.startswith('---') %}
                                <div class="diff-line diff-line-removed">{{ line }}</div>
                            {% elif line.startswith('@@') %}
                                <div class="diff-line diff-line-info">{{ line }}</div>
                            {% elif line.startswith('---') or line.startswith('+++') %}
                                <div class="diff-header">{{ line }}</div>
                            {% else %}
                                <div class="diff-line">{{ line }}</div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="no-changes">No se encontraron diferencias</div>
                    {% endif %}
                {% endif %}
            </div>

            <div id="{{ host }}_lsblk" class="file-content">
                {% set lsblk_diff_data = hostvars_lsblk_diff.get(host, {}).get('lsblk_diff_content', {}) %}
                {% if not lsblk_diff_data.content is defined %}
                    <div class="error-message">
                        No se encontraron datos de diferencias
                    </div>
                {% else %}
                    {% set lsblk_diff_output = lsblk_diff_data.content | b64decode %}
                    {% if lsblk_diff_output | length > 0 %}
                        {% for line in lsblk_diff_output.split('\n') %}
                            {% if line.startswith('+') and not line.startswith('+++') %}
                                <div class="diff-line diff-line-added">{{ line }}</div>
                            {% elif line.startswith('-') and not line.startswith('---') %}
                                <div class="diff-line diff-line-removed">{{ line }}</div>
                            {% elif line.startswith('@@') %}
                                <div class="diff-line diff-line-info">{{ line }}</div>
                            {% elif line.startswith('---') or line.startswith('+++') %}
                                <div class="diff-header">{{ line }}</div>
                            {% else %}
                                <div class="diff-line">{{ line }}</div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="no-changes">No se encontraron diferencias</div>
                    {% endif %}
                {% endif %}
            </div>

            <div id="{{ host }}_vg" class="file-content">
                {% set vg_diff_data = hostvars_vg_diff.get(host, {}).get('vg_diff_content', {}) %}
                {% if not vg_diff_data.content is defined %}
                    <div class="error-message">
                        No se encontraron datos de diferencias
                    </div>
                {% else %}
                    {% set vg_diff_output = vg_diff_data.content | b64decode %}
                    {% if vg_diff_output | length > 0 %}
                        {% for line in vg_diff_output.split('\n') %}
                            {% if line.startswith('+') and not line.startswith('+++') %}
                                <div class="diff-line diff-line-added">{{ line }}</div>
                            {% elif line.startswith('-') and not line.startswith('---') %}
                                <div class="diff-line diff-line-removed">{{ line }}</div>
                            {% elif line.startswith('@@') %}
                                <div class="diff-line diff-line-info">{{ line }}</div>
                            {% elif line.startswith('---') or line.startswith('+++') %}
                                <div class="diff-header">{{ line }}</div>
                            {% else %}
                                <div class="diff-line">{{ line }}</div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="no-changes">No se encontraron diferencias</div>
                    {% endif %}
                {% endif %}
            </div>


            <div id="{{ host }}_netstat" class="file-content">
                {% set netstat_diff_data = hostvars_netstat_diff.get(host, {}).get('netstat_diff_content', {}) %}
                {% if not netstat_diff_data.content is defined %}
                    <div class="error-message">
                        No se encontraron datos de diferencias
                    </div>
                {% else %}
                    {% set netstat_diff_output = netstat_diff_data.content | b64decode %}
                    {% if netstat_diff_output | length > 0 %}
                        {% for line in netstat_diff_output.split('\n') %}
                            {% if line.startswith('+') and not line.startswith('+++') %}
                                <div class="diff-line diff-line-added">{{ line }}</div>
                            {% elif line.startswith('-') and not line.startswith('---') %}
                                <div class="diff-line diff-line-removed">{{ line }}</div>
                            {% elif line.startswith('@@') %}
                                <div class="diff-line diff-line-info">{{ line }}</div>
                            {% elif line.startswith('---') or line.startswith('+++') %}
                                <div class="diff-header">{{ line }}</div>
                            {% else %}
                                <div class="diff-line">{{ line }}</div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="no-changes">No se encontraron diferencias</div>
                    {% endif %}
                {% endif %}
            </div>

            <div id="{{ host }}_ipaddr" class="file-content">
                {% set ipaddr_diff_data = hostvars_ipaddr_diff.get(host, {}).get('ipaddr_diff_content', {}) %}
                {% if not ipaddr_diff_data.content is defined %}
                    <div class="error-message">
                        No se encontraron datos de diferencias
                    </div>
                {% else %}
                    {% set ipaddr_diff_output = ipaddr_diff_data.content | b64decode %}
                    {% if ipaddr_diff_output | length > 0 %}
                        {% for line in ipaddr_diff_output.split('\n') %}
                            {% if line.startswith('+') and not line.startswith('+++') %}
                                <div class="diff-line diff-line-added">{{ line }}</div>
                            {% elif line.startswith('-') and not line.startswith('---') %}
                                <div class="diff-line diff-line-removed">{{ line }}</div>
                            {% elif line.startswith('@@') %}
                                <div class="diff-line diff-line-info">{{ line }}</div>
                            {% elif line.startswith('---') or line.startswith('+++') %}
                                <div class="diff-header">{{ line }}</div>
                            {% else %}
                                <div class="diff-line">{{ line }}</div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="no-changes">No se encontraron diferencias</div>
                    {% endif %}
                {% endif %}
            </div>

    </div>
    {% endfor %}
    </div>

    <script>
        // Mostrar el primer servidor por defecto
        document.addEventListener('DOMContentLoaded', function() {
            const firstServer = document.querySelector('.server-item');
            if (firstServer) {
                const hostId = firstServer.textContent.trim().replace(/[●○]/g, '').trim();
                showServer(hostId);
            }
        });

        function showServer(host) {
            // Actualizar menú lateral
            document.querySelectorAll('.server-item').forEach(item => {
                item.classList.remove('active');
                if (item.textContent.includes(host)) {
                    item.classList.add('active');
                }
            });
            
            // Mostrar contenido del servidor seleccionado
            document.querySelectorAll('.diff-container').forEach(container => {
                container.classList.remove('active');
            });
            document.getElementById(host).classList.add('active');
        }

        function showFile(host, file) {
            // Actualizar pestañas
            const tabs = document.querySelectorAll(`#${host} .file-tab`);
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Mostrar contenido del archivo seleccionado
            const contents = document.querySelectorAll(`#${host} .file-content`);
            contents.forEach(content => content.classList.remove('active'));
            
            document.querySelector(`#${host} .file-tab[onclick*="${file}"]`).classList.add('active');
            document.getElementById(`${host}_${file}`).classList.add('active');
        }
    </script>
</body>
</html>